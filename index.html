<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¤šäººå‡ºéŠåˆ†å¸³ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card { border-radius: 12px; }
        .weight-input::-webkit-inner-spin-button { display: none; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8 font-sans">
    <div class="max-w-5xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border-b-4 border-indigo-500">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-2xl font-black text-slate-800">å‡ºéŠåˆ†å¸³åŠ©æ‰‹</h1>
                <p class="text-slate-400 text-sm">è«‹å…ˆæ–¼ä¸‹æ–¹ã€Œæˆå“¡ç®¡ç†ã€åŠ å…¥åƒèˆ‡è€…</p>
            </div>
            <div class="flex gap-2">
                <button onclick="copyToClipboard()" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-200 transition">ğŸ“‹ è¤‡è£½ LINE è¨Šæ¯</button>
                <button onclick="resetAll()" class="bg-red-50 text-red-500 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition">ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 card shadow-sm">
                    <h2 class="text-lg font-bold mb-4 text-slate-700">1. æˆå“¡ç®¡ç†</h2>
                    <div id="member-status" class="space-y-2 mb-4">
                        </div>
                    <div class="flex gap-2">
                        <input id="new-member" type="text" placeholder="è¼¸å…¥å§“å..." class="flex-1 border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-400 outline-none">
                        <button onclick="addMember()" class="bg-indigo-600 text-white px-4 rounded-lg font-bold">åŠ å…¥</button>
                    </div>
                </div>

                <div class="bg-white p-6 card shadow-sm border-t-4 border-emerald-500">
                    <h2 class="text-lg font-bold mb-4 text-slate-700">2. æ–°å¢æ”¯å‡º</h2>
                    <div class="space-y-4 text-sm">
                        <input id="desc" type="text" placeholder="é …ç›® (å¦‚: æ²¹éŒ¢ã€é–€ç¥¨)" class="w-full border rounded-lg p-2">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="payer" class="border rounded-lg p-2 bg-gray-50 font-medium text-indigo-600"></select>
                            <input id="amount" type="number" placeholder="é‡‘é¡" class="border rounded-lg p-2">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg border border-dashed border-slate-300">
                            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">åƒèˆ‡åˆ†æ”¤çš„äººå“¡èˆ‡æ¬Šé‡</p>
                            <div id="participant-list" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-xs text-slate-400 italic">è«‹å…ˆåŠ å…¥æˆå“¡...</p>
                            </div>
                        </div>
                        <button onclick="addExpense()" class="w-full bg-slate-800 text-white py-3 rounded-xl hover:bg-black transition font-bold shadow-md">ç¢ºèªåŠ å…¥ç´€éŒ„</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 card shadow-sm">
                    <h2 class="text-lg font-bold mb-4 text-slate-700 flex justify-between items-center">
                        3. èª°è©²çµ¦èª°éŒ¢ (çµç®—)
                        <span class="text-xs font-normal text-slate-400">æœ€å°‘è½‰å¸³æ¬¡æ•¸æ¼”ç®—æ³•</span>
                    </h2>
                    <div id="settlement-result" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p class="text-slate-400 italic text-sm">å°šæœªæœ‰å¸³ç›®...</p>
                    </div>
                </div>

                <div class="bg-white p-6 card shadow-sm">
                    <h2 class="text-lg font-bold mb-4 text-slate-700">æ”¯å‡ºæ˜ç´°æ­·å²</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase">
                                <tr>
                                    <th class="py-3 px-4">é …ç›®</th>
                                    <th class="py-3 px-4">ä»˜æ¬¾äºº</th>
                                    <th class="py-3 px-4 text-right">é‡‘é¡</th>
                                    <th class="py-3 px-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="expense-history" class="text-sm divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–ï¼šå˜—è©¦å¾ LocalStorage è®€å–è³‡æ–™
        let members = JSON.parse(localStorage.getItem('trip_members')) || [];
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
        let finalSettlementText = "";

        function saveData() {
            localStorage.setItem('trip_members', JSON.stringify(members));
            localStorage.setItem('trip_expenses', JSON.stringify(expenses));
        }

        function addMember() {
            const val = document.getElementById('new-member').value.trim();
            if (val && !members.includes(val)) {
                members.push(val);
                document.getElementById('new-member').value = '';
                saveData();
                renderUI();
            } else if (members.includes(val)) {
                alert("æˆå“¡åç¨±é‡è¤‡ï¼");
            }
        }

        function removeMember(name) {
            if (confirm(`ç¢ºå®šåˆªé™¤ ${name}ï¼Ÿå…¶ç›¸é—œæ”¯å‡ºä¹Ÿæœƒè¢«ç§»é™¤ã€‚`)) {
                members = members.filter(m => m !== name);
                expenses = expenses.filter(e => e.payer !== name);
                saveData();
                renderUI();
            }
        }

        function addExpense() {
            const desc = document.getElementById('desc').value;
            const payer = document.getElementById('payer').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const participants = [];
            
            document.querySelectorAll('.member-checkbox:checked').forEach(cb => {
                const name = cb.value;
                const weight = parseFloat(document.querySelector(`.weight-input[data-member="${name}"]`).value) || 0;
                participants.push({ name, weight });
            });

            if (!desc || isNaN(amount) || amount <= 0) return alert("è«‹è¼¸å…¥é …ç›®åç¨±èˆ‡æ­£ç¢ºé‡‘é¡");
            if (participants.length === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€ä½åˆ†æ”¤è€…");

            expenses.push({ id: Date.now(), desc, payer, amount, participants });
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            saveData();
            renderUI();
        }

        function deleteExpense(id) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ")) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                renderUI();
            }
        }

        function resetAll() {
            if (confirm("é€™å°‡æœƒæ¸…é™¤æ‰€æœ‰æ­·å²ç´€éŒ„èˆ‡æˆå“¡ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                localStorage.clear();
                members = [];
                expenses = [];
                renderUI();
            }
        }

        function calculate() {
            let balances = {};
            members.forEach(m => balances[m] = 0);
            
            expenses.forEach(exp => {
                if (balances[exp.payer] !== undefined) balances[exp.payer] += exp.amount;
                const activeParticipants = exp.participants.filter(p => members.includes(p.name));
                const totalWeight = activeParticipants.reduce((sum, p) => sum + p.weight, 0);
                
                if (totalWeight > 0) {
                    activeParticipants.forEach(p => {
                        balances[p.name] -= (p.weight / totalWeight) * exp.amount;
                    });
                }
            });
            return balances;
        }

        function renderUI() {
            const balances = calculate();
            
            // 1. æˆå“¡ç‹€æ…‹èˆ‡é¤˜é¡
            const statusDiv = document.getElementById('member-status');
            statusDiv.innerHTML = members.length ? members.map(m => {
                const bal = balances[m] || 0;
                const colorClass = bal >= 0.1 ? 'text-green-600' : (bal < -0.1 ? 'text-red-500' : 'text-slate-400');
                return `
                    <div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                        <div class="flex items-center">
                            <button onclick="removeMember('${m}')" class="text-slate-300 hover:text-red-500 mr-2 text-xs">âœ•</button>
                            <span class="text-sm font-medium text-slate-700">${m}</span>
                        </div>
                        <span class="text-xs font-mono font-bold ${colorClass}">${bal > 0.1 ? '+' : ''}${bal.toFixed(1)}</span>
                    </div>
                `;
            }).join('') : '<p class="text-xs text-slate-400 italic">å°šæœªåŠ å…¥ä»»ä½•æˆå“¡...</p>';

            // 2. ä»˜æ¬¾äººé¸å–®
            document.getElementById('payer').innerHTML = members.map(m => `<option value="${m}">${m} ä»˜æ¬¾</option>`).join('');
            
            // 3. åˆ†æ”¤æ¸…å–®
            const pList = document.getElementById('participant-list');
            pList.innerHTML = members.length ? members.map(m => `
                <div class="flex justify-between items-center group">
                    <label class="flex items-center text-xs text-slate-600 cursor-pointer">
                        <input type="checkbox" checked value="${m}" class="member-checkbox mr-2 w-3 h-3 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        ${m}
                    </label>
                    <div class="flex items-center gap-1">
                        <span class="text-[9px] text-slate-300 uppercase">Weight</span>
                        <input type="number" step="0.1" value="1.0" class="w-8 border-b border-transparent group-hover:border-slate-300 bg-transparent text-[10px] text-center weight-input focus:border-indigo-500 outline-none" data-member="${m}">
                    </div>
                </div>
            `).join('') : '<p class="text-xs text-slate-400 italic">è«‹å…ˆåŠ å…¥æˆå“¡...</p>';

            // 4. æ­·å²ç´€éŒ„
            document.getElementById('expense-history').innerHTML = expenses.map(e => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="py-3 px-4 font-bold text-slate-700">${e.desc}</td>
                    <td class="py-3 px-4 text-slate-500">${e.payer}</td>
                    <td class="py-3 px-4 text-right font-mono text-indigo-600 font-bold">$${e.amount.toLocaleString()}</td>
                    <td class="py-3 px-4 text-center"><button onclick="deleteExpense(${e.id})" class="text-red-300 hover:text-red-600 text-xs underline">åˆªé™¤</button></td>
                </tr>
            `).reverse().join('');

            // 5. çµç®—æ¼”ç®—èˆ‡è¤‡è£½è¨Šæ¯æº–å‚™
            let receivers = Object.entries(balances).filter(b => b[1] > 0.1).sort((a,b) => b[1]-a[1]);
            let payers = Object.entries(balances).filter(b => b[1] < -0.1).sort((a,b) => a[1]-b[1]);
            const resDiv = document.getElementById('settlement-result');
            
            let html = "";
            let shareTxt = "ğŸ’° å‡ºéŠçµç®—å ±å‘Šï¼š\n------------------\n";
            let p_t = payers.map(p => [...p]);
            let r_t = receivers.map(r => [...r]);

            while (p_t.length > 0 && r_t.length > 0) {
                let amt = Math.min(Math.abs(p_t[0][1]), r_t[0][1]);
                let line = `ğŸ”¹ ${p_t[0][0]} âœ ${r_t[0][0]}ï¼š$${amt.toFixed(1)}`;
                html += `<div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex justify-between items-center shadow-sm">
                            <span class="text-sm font-medium text-slate-700">${p_t[0][0]} <span class="text-slate-300 mx-1">âœ</span> ${r_t[0][0]}</span>
                            <span class="font-black text-indigo-700 font-mono">$${amt.toFixed(1)}</span>
                         </div>`;
                shareTxt += line + "\n";
                p_t[0][1] += amt; r_t[0][1] -= amt;
                if (Math.abs(p_t[0][1]) < 0.1) p_t.shift();
                if (Math.abs(r_t[0][1]) < 0.1) r_t.shift();
            }
            resDiv.innerHTML = html || (expenses.length > 0 ? `<p class="text-green-500 font-bold text-sm">âœ” å¸³ç›®å·²å¹³å¸³ï¼Œç„¡é ˆåŒ¯æ¬¾</p>` : `<p class="text-slate-400 italic text-sm">å°šæœªæœ‰è³‡æ–™...</p>`);
            finalSettlementText = shareTxt + "------------------\nç”¢è‡ªåˆ†å¸³åŠ©æ‰‹ã€‚";
        }

        function copyToClipboard() {
            if (expenses.length === 0) return alert("å°šç„¡è³‡æ–™å¯è¤‡è£½");
            navigator.clipboard.writeText(finalSettlementText);
            alert("çµç®—è¨Šæ¯å·²æˆåŠŸè¤‡è£½ï¼å¯ç›´æ¥è²¼ä¸Šè‡³ LINE ç¾¤çµ„ã€‚");
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>